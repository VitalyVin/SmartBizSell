# Инструкция по установке SmartBizSell

## Требования

- PHP 7.4 или выше
- MySQL 8.0 / Percona Server 8.0
- Веб-сервер (Apache/Nginx)
- PDO расширение для PHP
- Хостинг reg.ru (или другой с поддержкой MySQL 8.0)

## Быстрая установка на reg.ru

### 1. Подготовка базы данных

1. Войдите в панель управления reg.ru
2. Перейдите в раздел "Базы данных MySQL"
3. Убедитесь, что у вас есть база данных MySQL 8.0 (Percona Server)
4. Запомните следующие данные:
   - **Имя базы данных** (рекомендуется: `u3064951_SmartBizSell`)
   - **Имя пользователя** (например, `u3064951_default`)
   - **Пароль** от базы данных
   - **Хост** (обычно `localhost`)

### 2. Импорт структуры базы данных

**Через phpMyAdmin (рекомендуется):**

1. Откройте phpMyAdmin в панели управления reg.ru
2. Выберите вашу базу данных в левом меню
3. Перейдите на вкладку **"SQL"**
4. Откройте файл `db/schema.sql` в текстовом редакторе
5. Скопируйте содержимое файла (начиная с `CREATE TABLE IF NOT EXISTS users`)
6. Вставьте SQL-код в окно phpMyAdmin
7. Нажмите **"Вперед"** (Execute)

**Или через импорт:**

1. В phpMyAdmin выберите вашу базу данных
2. Перейдите на вкладку **"Импорт"**
3. Нажмите **"Выбрать файл"** и выберите `db/schema.sql`
4. Нажмите **"Вперед"**

После успешного импорта будут созданы основные таблицы:
- `users` - пользователи (продавцы)
- `seller_forms` - анкеты продавцов
- `user_sessions` - сессии пользователей (опционально)

**Важно:** После импорта основной структуры необходимо выполнить миграцию для таблицы модерации тизеров (см. раздел "Миграция для модерации тизеров" ниже).

### 3. Миграция для модерации тизеров

После импорта основной структуры БД необходимо создать таблицу для модерации тизеров:

**Через phpMyAdmin:**

1. Откройте phpMyAdmin в панели управления reg.ru
2. Выберите вашу базу данных
3. Перейдите на вкладку **"SQL"**
4. Откройте файл `db/migration_published_teasers.sql` в текстовом редакторе
5. Скопируйте содержимое файла
6. Вставьте SQL-код в окно phpMyAdmin
7. Нажмите **"Вперед"** (Execute)

**Или через импорт:**

1. В phpMyAdmin выберите вашу базу данных
2. Перейдите на вкладку **"Импорт"**
3. Нажмите **"Выбрать файл"** и выберите `db/migration_published_teasers.sql`
4. Нажмите **"Вперед"**

После успешного импорта будет создана таблица:
- `published_teasers` - тизеры на модерации и опубликованные тизеры

**Примечание:** Таблица также может быть создана автоматически при первом использовании функционала модерации (через функцию `ensurePublishedTeasersTable()`), но рекомендуется создать её вручную для контроля.

### 4. Миграция для документов активов

После импорта основной структуры БД необходимо создать таблицу для хранения документов активов:

**Через phpMyAdmin:**

1. Откройте phpMyAdmin в панели управления reg.ru
2. Выберите вашу базу данных
3. Перейдите на вкладку **"SQL"**
4. Откройте файл `db/migration_asset_documents.sql` в текстовом редакторе
5. Скопируйте содержимое файла
6. Вставьте SQL-код в окно phpMyAdmin
7. Нажмите **"Вперед"** (Execute)

**Или через импорт:**

1. В phpMyAdmin выберите вашу базу данных
2. Перейдите на вкладку **"Импорт"**
3. Нажмите **"Выбрать файл"** и выберите `db/migration_asset_documents.sql`
4. Нажмите **"Вперед"**

После успешного импорта будет создана таблица:
- `asset_documents` - документы, привязанные к активам на продажу

**Примечание:** Таблица также может быть создана автоматически при первом использовании функционала загрузки документов (через функцию `ensureAssetDocumentsTable()`), но рекомендуется создать её вручную для контроля.

### 5. Настройка папки для загрузки документов

1. Создайте папку `uploads/asset_documents/` в корне проекта:
   ```bash
   mkdir -p uploads/asset_documents
   ```

2. Установите права доступа на папку (для записи файлов):
   ```bash
   chmod 755 uploads
   chmod 755 uploads/asset_documents
   ```

3. Убедитесь, что веб-сервер имеет права на запись в эту папку. На reg.ru обычно используется пользователь `u3064951`:
   ```bash
   chown -R u3064951:u3064951 uploads
   ```

**Важно:** Папка `uploads/asset_documents/` должна быть доступна для записи веб-сервером, иначе загрузка документов не будет работать.

### 6. Настройка конфигурации

1. Скопируйте файл `config.php.example` в `config.php`:
   ```bash
   cp config.php.example config.php
   ```

2. Откройте `config.php` и обновите следующие параметры:

```php
// Настройки подключения к MySQL
define('DB_HOST', 'localhost'); // Обычно localhost для reg.ru
define('DB_NAME', 'u3064951_SmartBizSell'); // Имя вашей базы данных
define('DB_USER', 'u3064951_default'); // Имя пользователя БД
define('DB_PASS', 'ваш_пароль_от_БД'); // Пароль от базы данных
define('DB_CHARSET', 'utf8mb4'); // UTF-8 Unicode

// Пути
define('BASE_URL', 'https://smartbizsell.ru'); // Ваш домен
define('ADMIN_EMAIL', 'admin@smartbizsell.ru'); // Email администратора

// Email модератора (для доступа к интерфейсу модерации)
define('MODERATOR_EMAIL', 'moderator@smartbizsell.ru'); // Email модератора

// API ключ для Together.ai (для генерации тизеров и Term Sheet)
define('TOGETHER_API_KEY', 'ваш_api_ключ'); // Получите на https://together.ai
define('TOGETHER_MODEL', 'Qwen/Qwen2.5-72B-Instruct-Turbo'); // Модель ИИ
```

**Важно:** 
- Файл `config.php` содержит пароли и не должен попадать в git репозиторий. Он уже добавлен в `.gitignore`.
- Email модератора должен совпадать с email пользователя, который будет модерировать тизеры.
- Для работы генерации тизеров необходим API ключ от Together.ai.

### 5. Загрузка файлов на сервер

Загрузите все файлы проекта на ваш хостинг через FTP/SFTP или файловый менеджер reg.ru:

```
/
├── config.php (создайте из config.php.example)
├── index.php                      # Главная страница с каталогом бизнесов
├── dashboard.php                  # Личный кабинет продавца
├── seller_form.php                # Форма анкеты продавца
├── view_form.php                  # Просмотр анкеты
├── generate_teaser.php            # Генерация тизера через ИИ
├── calculate_multiplier_valuation.php  # Расчет оценки по мультипликаторам
├── moderation.php                 # Интерфейс модерации тизеров
├── moderation_api.php             # API для модерации тизеров
├── submit_teaser_moderation.php   # Отправка тизера на модерацию
├── view_teaser.php                # Просмотр полного HTML тизера
├── term_sheet_form.php            # Форма Term Sheet
├── generate_term_sheet.php        # Генерация Term Sheet через ИИ
├── investor_utils.php             # Утилиты для работы с инвесторами
├── login.php                      # Страница входа
├── register.php                   # Страница регистрации
├── logout.php                     # Выход из системы
├── script.js                      # JavaScript функциональность
├── styles.css                     # Стили оформления
├── .htaccess                      # Настройки Apache
└── db/
    ├── schema.sql                 # SQL скрипт для создания структуры БД
    └── migration_published_teasers.sql  # Миграция для таблицы модерации
```

### 6. Настройка прав доступа

Убедитесь, что файлы имеют правильные права доступа:

```bash
chmod 644 config.php
chmod 644 *.php
chmod 644 *.js
chmod 644 *.css
chmod 755 db/
```

### 7. Настройка модератора

Для доступа к интерфейсу модерации необходимо:

1. Зарегистрировать пользователя с email, указанным в `MODERATOR_EMAIL` в `config.php`
2. Войти в систему под этим пользователем
3. Перейти на страницу `moderation.php` - интерфейс модерации будет доступен

**Важно:** Только пользователь с email, совпадающим с `MODERATOR_EMAIL`, имеет доступ к интерфейсу модерации.

### 8. Проверка установки

1. Откройте в браузере страницу регистрации:
   ```
   https://ваш-домен.ru/register.php
   ```

2. Если страница загружается без ошибок - подключение к БД настроено правильно.

3. Попробуйте зарегистрировать тестового пользователя.

4. Войдите в систему и проверьте личный кабинет.

## Структура файлов

### Основные файлы:

**Конфигурация:**
- `config.php` - Конфигурация БД и функции (создается из `config.php.example`)
- `config.php.example` - Шаблон конфигурации (без паролей)

**Основные страницы:**
- `index.php` - Главная страница с каталогом бизнесов
- `register.php` - Страница регистрации
- `login.php` - Страница входа
- `logout.php` - Выход из системы
- `dashboard.php` - Личный кабинет продавца

**Анкеты и формы:**
- `seller_form.php` - Форма анкеты продавца
- `view_form.php` - Просмотр анкеты
- `term_sheet_form.php` - Форма Term Sheet

**Генерация контента:**
- `generate_teaser.php` - Генерация тизера через ИИ
- `generate_term_sheet.php` - Генерация Term Sheet через ИИ
- `calculate_multiplier_valuation.php` - Расчет оценки по мультипликаторам

**Модерация:**
- `moderation.php` - Интерфейс модерации тизеров
- `moderation_api.php` - API для модерации тизеров
- `submit_teaser_moderation.php` - Отправка тизера на модерацию
- `view_teaser.php` - Просмотр полного HTML тизера

**Документы активов:**
- `upload_asset_document.php` - API для загрузки документов
- `delete_asset_document.php` - API для удаления документов
- `get_asset_documents.php` - API для получения списка документов
- `download_asset_document.php` - API для скачивания документов
- `uploads/asset_documents/` - Папка для хранения загруженных документов

**Утилиты:**
- `investor_utils.php` - Утилиты для работы с инвесторами
- `script.js` - JavaScript функциональность
- `styles.css` - Стили оформления
- `.htaccess` - Настройки Apache

### База данных:

- `db/schema.sql` - SQL скрипт для создания основной структуры БД
- `db/migration_published_teasers.sql` - Миграция для таблицы модерации тизеров
- `db/migration_asset_documents.sql` - Миграция для таблицы документов активов
- `db/README.md` - Дополнительная документация по БД

## Функциональность

### Для продавцов:

1. **Регистрация** - создание аккаунта с email и паролем
2. **Вход** - авторизация в системе
3. **Личный кабинет** - управление несколькими активами одновременно
4. **Анкеты** - заполнение и сохранение анкет в БД (с поддержкой черновиков)
5. **Отслеживание статуса** - просмотр статуса анкет:
   - Черновик
   - Отправлена
   - На проверке
   - Одобрена
   - Отклонена
6. **Генерация тизеров** - автоматическое создание тизеров через ИИ
7. **Hero блок тизера** - визуальный блок с ключевой информацией (чипы, статистика)
8. **Маскирование названия** - возможность скрыть название компании в тизере
9. **Отправка на модерацию** - отправка тизера на проверку перед публикацией
10. **DCF модель** - автоматический расчет финансовой модели
11. **Оценка по мультипликаторам** - расчет стоимости бизнеса
12. **Term Sheet** - генерация инвестиционного меморандума
13. **Загрузка документов** - возможность загружать документы для активов (PDF, DOC, DOCX, XLS, XLSX, изображения, архивы)
14. **Управление документами** - просмотр, удаление загруженных документов с индикатором использования места (до 20 МБ на актив)

### Для покупателей:

1. **Каталог бизнесов** - просмотр доступных бизнесов на главной странице
2. **Фильтрация** - поиск по отрасли, цене, городу
3. **Детальная информация** - полное описание бизнеса с финансовыми показателями
4. **Финансовые графики** - визуализация финансовых данных в тизерах
5. **Современные карточки** - красивое представление бизнесов с чипами и статистикой
6. **Скачивание документов** - доступ к документам, загруженным продавцом (презентации, отчеты, фотографии и т.д.)

### Для модераторов:

1. **Интерфейс модерации** - список тизеров с фильтрацией по статусу
2. **Редактирование HTML** - возможность редактировать HTML тизера
3. **Предпросмотр** - реальный предпросмотр отредактированного тизера
4. **Одобрение/отклонение** - управление статусами тизеров
5. **Публикация** - публикация одобренных тизеров на главной странице
6. **Заметки** - возможность оставить комментарии при отклонении

### Безопасность:

- ✅ Пароли хешируются с использованием bcrypt (cost 12)
- ✅ Защита от SQL-инъекций через PDO prepared statements
- ✅ Санитизация всех пользовательских данных
- ✅ Защищенные сессии с httponly cookies
- ✅ Валидация всех входных данных
- ✅ `config.php` исключен из git через `.gitignore`

## Информация о сервере

### Для reg.ru:

- **Сервер**: MySQL 8.0 (Percona Server)
- **Хост**: localhost (via UNIX socket)
- **Кодировка**: UTF-8 Unicode (utf8mb4)
- **SSL**: Не используется для localhost подключений

Percona Server 8.0 полностью совместим с MySQL 8.0, все функции работают корректно.

## Устранение неполадок

### Ошибка подключения к БД

**Симптомы:** Страница не загружается, ошибка "Database connection error"

**Решение:**
1. Проверьте правильность данных в `config.php`:
   - Имя базы данных
   - Имя пользователя
   - Пароль
   - Хост (обычно `localhost`)
2. Убедитесь, что база данных существует
3. Проверьте, что пользователь имеет права на базу данных
4. Проверьте логи ошибок PHP

### Ошибка "Table doesn't exist"

**Симптомы:** Ошибка при попытке зарегистрироваться или войти, или при работе с модерацией

**Решение:**
1. Выполните SQL скрипт из `db/schema.sql` для создания основных таблиц
2. Выполните миграцию из `db/migration_published_teasers.sql` для таблицы модерации
3. Выполните миграцию из `db/migration_asset_documents.sql` для таблицы документов активов
4. Убедитесь, что вы выбрали правильную базу данных в phpMyAdmin
5. Проверьте, что все таблицы созданы:
   - `users` - пользователи
   - `seller_forms` - анкеты продавцов
   - `user_sessions` - сессии пользователей (опционально)
   - `published_teasers` - тизеры на модерации
   - `asset_documents` - документы активов
   - `term_sheet_forms` - формы Term Sheet (создается автоматически)

### Сессии не работают

**Симптомы:** После входа сразу выкидывает, не запоминает пользователя

**Решение:**
1. Убедитесь, что PHP сессии включены
2. Проверьте, что папка для сессий доступна для записи
3. В `config.php` проверьте настройки сессий
4. Для HTTPS сайтов убедитесь, что `session.cookie_secure` установлен правильно

### Ошибка "Call to undefined function"

**Симптомы:** Ошибка при загрузке страницы

**Решение:**
1. Убедитесь, что файл `config.php` существует
2. Проверьте, что все файлы загружены на сервер
3. Проверьте пути к файлам в `require_once`

### Проблемы с кодировкой

**Симптомы:** Кракозябры вместо русских букв

**Решение:**
1. Убедитесь, что база данных использует кодировку `utf8mb4`
2. Проверьте, что в `config.php` указано `DB_CHARSET = 'utf8mb4'`
3. Убедитесь, что файлы PHP сохранены в кодировке UTF-8

### Ошибка загрузки документов

**Симптомы:** Не удается загрузить документы, ошибка "Не удалось сохранить файл на сервер"

**Решение:**
1. Проверьте, что папка `uploads/asset_documents/` существует и доступна для записи:
   ```bash
   ls -la uploads/asset_documents/
   ```
2. Убедитесь, что веб-сервер имеет права на запись в папку:
   ```bash
   chmod 755 uploads
   chmod 755 uploads/asset_documents
   chown -R u3064951:u3064951 uploads
   ```
3. Проверьте, что таблица `asset_documents` создана в базе данных
4. Убедитесь, что в `php.ini` установлены достаточные значения для `upload_max_filesize` и `post_max_size` (минимум 20 МБ)
5. Проверьте логи ошибок PHP для получения детальной информации об ошибке

## Дополнительная информация

### Логи ошибок

Для отладки проверьте логи ошибок:
- Логи PHP обычно находятся в `/var/log/php/` или в панели управления хостингом
- Логи MySQL в панели управления reg.ru

### Обновление

При обновлении проекта:
1. Сделайте резервную копию базы данных
2. Сделайте резервную копию `config.php`
3. Загрузите новые файлы
4. Восстановите `config.php` из резервной копии
5. При необходимости выполните миграции БД:
   - Если таблица `published_teasers` не существует, выполните `db/migration_published_teasers.sql`
   - Таблица может быть создана автоматически, но рекомендуется выполнить миграцию вручную
6. Проверьте, что все новые файлы загружены (особенно файлы модерации)
7. Убедитесь, что `MODERATOR_EMAIL` настроен в `config.php`

### Резервное копирование

Рекомендуется регулярно делать резервные копии:
- База данных (через phpMyAdmin → Экспорт)
- Файл `config.php`
- Все файлы проекта

## Дополнительные настройки

### Настройка Together.ai API

Для работы генерации тизеров и Term Sheet необходим API ключ от Together.ai:

1. Зарегистрируйтесь на https://together.ai
2. Получите API ключ в личном кабинете
3. Добавьте ключ в `config.php`:
   ```php
   define('TOGETHER_API_KEY', 'ваш_api_ключ');
   ```

### Настройка модератора

1. Зарегистрируйте пользователя с email, который будет использоваться для модерации
2. Укажите этот email в `config.php`:
   ```php
   define('MODERATOR_EMAIL', 'moderator@smartbizsell.ru');
   ```
3. Войдите в систему под этим пользователем
4. Перейдите на `moderation.php` - интерфейс модерации будет доступен

### Проверка работы модерации

1. Создайте тестовую анкету и сгенерируйте тизер
2. Отправьте тизер на модерацию из личного кабинета
3. Войдите под модератором и проверьте, что тизер появился в списке
4. Отредактируйте тизер, одобрите и опубликуйте
5. Проверьте, что тизер появился на главной странице

## Поддержка

При возникновении проблем:
1. Проверьте логи ошибок PHP и MySQL
2. Убедитесь, что все шаги установки выполнены правильно
3. Проверьте документацию в `db/README.md`
4. Убедитесь, что все миграции БД выполнены
5. Проверьте настройки `MODERATOR_EMAIL` и `TOGETHER_API_KEY` в `config.php`

---

**Версия:** 2.0  
**Дата обновления:** 2025-01
