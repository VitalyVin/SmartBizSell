# Тестовый модуль SmartBizSell

Полноценный инструмент для ручного тестирования всех функций платформы SmartBizSell.

## Описание

Тестовый модуль предоставляет веб-интерфейс для запуска и просмотра результатов тестов всех компонентов платформы. Модуль включает тесты для:

- Авторизации и регистрации
- Анкет продавца (стартапы и зрелые компании)
- Генерации тизеров
- Модерации тизеров
- DCF модели и мультипликаторов
- Генерации Term Sheet
- Личного кабинета
- Каталога бизнесов
- Работы с документами
- Восстановления пароля

## Безопасность

**ВАЖНО:** Тестовый модуль доступен только в режиме разработки!

Модуль автоматически проверяет переменную окружения `APP_ENV` и блокирует доступ на production серверах. Для использования на production необходимо явно установить `APP_ENV=development` в файле `.env`.

## Изоляция тестов от базы данных

**По умолчанию все тесты изолированы от реальной БД!**

Тестовый модуль использует транзакции MySQL для автоматической изоляции тестов:

- **Автоматический откат**: Все изменения в БД автоматически откатываются после каждого теста
- **Изоляция тестов**: Каждый тест выполняется в отдельной транзакции
- **Чистая БД**: Тестовые данные не остаются в базе после выполнения тестов
- **Безопасность**: Можно безопасно запускать тесты на реальной БД

### Настройка транзакций

Транзакции включены по умолчанию. Для отключения (не рекомендуется) установите в `tests/config.php`:

```php
define('TEST_USE_TRANSACTIONS', false);
```

Или через переменную окружения:

```bash
export TEST_USE_TRANSACTIONS=false
```

**Внимание:** При отключении транзакций тесты будут изменять реальную БД. Убедитесь, что это безопасно!

## Установка

1. Убедитесь, что структура директорий создана:
   ```
   tests/
   ├── classes/
   ├── assets/
   └── ...
   ```

2. Настройте конфигурацию в `tests/config.php`:
   - Проверьте подключение к базе данных
   - Настройте тестовые данные (email, пароли)
   - Укажите базовый URL для тестов

3. Откройте в браузере:
   ```
   https://your-domain.com/tests/
   ```

## Использование

### Веб-интерфейс

1. Откройте главную страницу тестового модуля
2. В левой панели выберите тестовый класс
3. Нажмите кнопку ▶ для запуска всех тестов класса
4. Или нажмите "Запустить все тесты" для полного тестирования
5. Просматривайте результаты в центральной панели
6. Кликните на тест для просмотра деталей в правой панели

### Структура тестов

Каждый тестовый класс содержит методы, начинающиеся с `test`, которые автоматически обнаруживаются и запускаются.

Пример:
```php
class AuthTest
{
    public function testRegistration()
    {
        // Тест регистрации
    }
    
    public function testLogin()
    {
        // Тест входа
    }
}
```

### Assertions (Проверки)

Доступные методы для проверки результатов:

- `assertTrue($condition, $message)` - проверка истинности
- `assertFalse($condition, $message)` - проверка ложности
- `assertEquals($expected, $actual, $message)` - проверка равенства
- `assertContains($needle, $haystack, $message)` - проверка наличия подстроки
- `assertInArray($needle, $haystack, $message)` - проверка наличия в массиве
- `assertNotEmpty($value, $message)` - проверка непустоты
- `assertIsArray($value, $message)` - проверка типа массива

### Выполнение HTTP-запросов

Для тестирования API и веб-страниц:

```php
// HTTP запрос
$response = $this->runner->makeRequest($url, 'POST', $data);

// Локальный файл
$result = $this->runner->executeLocalFile('path/to/file.php', $params, 'POST');
```

## Тестовые классы

### AuthTest
Тестирование авторизации и регистрации:
- Регистрация нового пользователя
- Регистрация с дублирующимся email
- Вход с валидными данными
- Вход с невалидными данными
- Валидация email и пароля

### FormTest
Тестирование анкет продавца:
- Создание анкеты для зрелой компании
- Создание анкеты для стартапа
- Сохранение черновика
- Валидация обязательных полей
- Сохранение данных в data_json

### TeaserTest
Тестирование генерации тизеров:
- Генерация тизера для зрелой компании
- Генерация тизера для стартапа
- Валидация перед генерацией
- Маскирование названия компании

### ModerationTest
Тестирование модерации тизеров:
- Отправка тизера на модерацию
- Одобрение тизера
- Отклонение тизера

### DCFTest
Тестирование DCF модели:
- Расчет DCF модели
- Расчет мультипликаторов
- Скрытие DCF для стартапов

### TermSheetTest
Тестирование генерации Term Sheet:
- Генерация в TXT формате
- Генерация в DOCX формате
- Проверка структуры

### DashboardTest
Тестирование личного кабинета:
- Отображение списка анкет
- Условное отображение для стартапов

### CatalogTest
Тестирование каталога бизнесов:
- Отображение каталога
- Отображение card_title и бейджа «Стартап» для объявлений с типом стартап
- Фильтрация по отраслям

### DocumentTest
Тестирование работы с документами:
- Загрузка документов
- Получение списка документов
- Удаление документов

### PasswordTest
Тестирование восстановления пароля:
- Запрос восстановления
- Валидация токена

## Добавление новых тестов

1. Создайте новый класс в `tests/classes/`:
   ```php
   class MyNewTest
   {
       private $runner;
       
       public function __construct(TestRunner $runner)
       {
           $this->runner = $runner;
       }
       
       public function testMyFeature()
       {
           $this->runner->runTest('Мой тест', function($r) {
               // Ваш тест
               $r->assertTrue(true, 'Тест пройден');
           });
       }
   }
   ```

2. Добавьте класс в список в `tests/index.php`:
   ```php
   $testClasses = [
       // ...
       'MyNewTest' => 'Описание нового теста',
   ];
   ```

## Очистка тестовых данных

**Очистка не требуется!** При включенных транзакциях (по умолчанию) все изменения автоматически откатываются после каждого теста.

Если транзакции отключены, тестовые классы имеют методы `cleanup()`, которые вызываются автоматически. Также можно вручную удалить тестовые записи:

```sql
DELETE FROM users WHERE email LIKE 'test_%';
DELETE FROM seller_forms WHERE asset_name LIKE 'Тест%';
```

### Как работают транзакции

1. Перед каждым тестом автоматически начинается транзакция (`BEGIN TRANSACTION`)
2. Тест выполняется внутри транзакции
3. После теста (успешного или проваленного) транзакция автоматически откатывается (`ROLLBACK`)
4. Все изменения в БД отменяются, БД остается в исходном состоянии

Это обеспечивает:
- Полную изоляцию тестов друг от друга
- Отсутствие "мусорных" данных в БД
- Возможность безопасного запуска на production БД (если нужно)

## Отчеты

Результаты тестов отображаются в реальном времени в веб-интерфейсе:

- **Статистика**: общее количество, пройдено, провалено
- **Детали теста**: проверки, ошибки, предупреждения
- **Время выполнения**: для каждого теста

## Устранение неполадок

### Тесты не запускаются
- Проверьте, что вы в режиме разработки
- Убедитесь, что все файлы на месте
- Проверьте права доступа к файлам

### Ошибки подключения к БД
- Проверьте настройки в `tests/config.php`
- Убедитесь, что используется правильная БД

### Тесты создают данные в production
- Проверьте переменную окружения `APP_ENV`
- Убедитесь, что тестовый модуль не доступен на production

## Лицензия

© 2026 SmartBizSell.ru. Все права защищены.
