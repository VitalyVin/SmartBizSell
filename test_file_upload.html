<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .upload-zone {
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-zone:hover {
            border-color: #667EEA;
            background: #f8f9ff;
        }
        .upload-zone.dragover {
            border-color: #667EEA;
            background: #f0f4ff;
        }
        .upload-btn {
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
        }
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        #file-input {
            display: none;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #667EEA;
            padding-left: 10px;
        }
        .log-entry.error {
            border-left-color: #dc3545;
            color: #dc3545;
        }
        .log-entry.success {
            border-left-color: #28a745;
            color: #28a745;
        }
        .file-list {
            margin-top: 20px;
        }
        .file-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤</h1>
        
        <div class="upload-zone" id="upload-zone">
            <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏</p>
            <button class="upload-btn" id="upload-btn">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã</button>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 20 –ú–ë
            </p>
        </div>
        
        <input type="file" id="file-input" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.webp,.zip,.rar,.7z,.txt,.csv">
        
        <div class="file-list" id="file-list"></div>
        
        <div class="log" id="log">
            <strong>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</strong>
            <div id="log-content"></div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function log(message, type = 'info') {
            const logContent = document.getElementById('log-content');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        const uploadZone = document.getElementById('upload-zone');
        const uploadBtn = document.getElementById('upload-btn');
        const fileInput = document.getElementById('file-input');
        const fileList = document.getElementById('file-list');

        log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');

        // –ú–µ—Ç–æ–¥ 1: Polling (–∫–∞–∫ –≤ dashboard.php)
        let fileCheckInterval = null;

        const handleUploadClick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            log('–ö–Ω–æ–ø–∫–∞ "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã" –Ω–∞–∂–∞—Ç–∞', 'info');
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
            if (fileCheckInterval) {
                clearInterval(fileCheckInterval);
                log('–ü—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'info');
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            const initialFileCount = fileInput.files ? fileInput.files.length : 0;
            log(`–ù–∞—á–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤: ${initialFileCount}`, 'info');
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
            fileInput.click();
            log('–î–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ –æ—Ç–∫—Ä—ã—Ç', 'info');
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º polling
            let pollCount = 0;
            const maxPolls = 100;
            
            fileCheckInterval = setInterval(() => {
                pollCount++;
                const currentFileCount = fileInput.files ? fileInput.files.length : 0;
                
                if (currentFileCount !== initialFileCount && currentFileCount > 0) {
                    log(`‚úÖ –§–ê–ô–õ–´ –û–ë–ù–ê–†–£–ñ–ï–ù–´ –ß–ï–†–ï–ó POLLING! –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${currentFileCount}`, 'success');
                    clearInterval(fileCheckInterval);
                    fileCheckInterval = null;
                    
                    handleFiles(fileInput.files);
                } else if (pollCount >= maxPolls) {
                    log('‚è±Ô∏è –¢–∞–π–º–∞—É—Ç polling - —Ñ–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã', 'error');
                    clearInterval(fileCheckInterval);
                    fileCheckInterval = null;
                } else if (pollCount % 10 === 0) {
                    log(`Polling: –ø—Ä–æ–≤–µ—Ä–∫–∞ #${pollCount}, —Ñ–∞–π–ª–æ–≤: ${currentFileCount}`, 'info');
                }
            }, 100);
        };

        // –ú–µ—Ç–æ–¥ 2: –°–æ–±—ã—Ç–∏–µ change (fallback)
        fileInput.addEventListener('change', function(e) {
            log('=== –°–û–ë–´–¢–ò–ï CHANGE –°–†–ê–ë–û–¢–ê–õ–û ===', 'success');
            if (e.target.files && e.target.files.length > 0) {
                if (fileCheckInterval) {
                    clearInterval(fileCheckInterval);
                    fileCheckInterval = null;
                    log('Polling –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—Ñ–∞–π–ª—ã –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ change)', 'info');
                }
                handleFiles(e.target.files);
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function handleFiles(files) {
            log(`–û–±—Ä–∞–±–æ—Ç–∫–∞ ${files.length} —Ñ–∞–π–ª(–æ–≤)`, 'info');
            
            fileList.innerHTML = '<h3>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:</h3>';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –ø–æ –æ–¥–Ω–æ–º—É
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                log(`–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ ${i + 1}/${files.length}: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} –ú–ë)`, 'info');
                
                // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.id = `file-item-${i}`;
                fileItem.innerHTML = `
                    <div>
                        <strong>${file.name}</strong><br>
                        <small>${(file.size / 1024 / 1024).toFixed(2)} –ú–ë ‚Ä¢ ${file.type || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø'}</small><br>
                        <small style="color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞...</small>
                    </div>
                `;
                fileList.appendChild(fileItem);
                
                try {
                    // –°–æ–∑–¥–∞–µ–º FormData
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    log(`–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ñ–∞–π–ª–∞: ${file.name}`, 'info');
                    const response = await fetch('test_upload_handler.php', {
                        method: 'POST',
                        body: formData
                    });
                    
                    log(`–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`, 'info');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        log(`–û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON. –û—Ç–≤–µ—Ç: ${text.substring(0, 200)}`, 'error');
                        throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞.');
                    }
                    
                    const result = await response.json();
                    log(`–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏: ${JSON.stringify(result)}`, 'info');
                    
                    if (!response.ok || !result.success) {
                        throw new Error(result.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ñ–∞–π–ª–∞
                    fileItem.innerHTML = `
                        <div>
                            <strong>${file.name}</strong><br>
                            <small>${(file.size / 1024 / 1024).toFixed(2)} –ú–ë ‚Ä¢ ${file.type || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø'}</small><br>
                            <small style="color: #28a745;">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω: ${result.file.saved_name}</small><br>
                            <small style="color: #666;">–ü—É—Ç—å: ${result.file.path}</small>
                        </div>
                    `;
                    fileItem.style.borderLeft = '3px solid #28a745';
                    
                    log(`‚úÖ –§–∞–π–ª ${i + 1} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω: ${result.file.saved_name}`, 'success');
                    
                } catch (error) {
                    log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ ${i + 1}: ${error.message}`, 'error');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å –æ—à–∏–±–∫–æ–π
                    fileItem.innerHTML = `
                        <div>
                            <strong>${file.name}</strong><br>
                            <small>${(file.size / 1024 / 1024).toFixed(2)} –ú–ë ‚Ä¢ ${file.type || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø'}</small><br>
                            <small style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞: ${error.message}</small>
                        </div>
                    `;
                    fileItem.style.borderLeft = '3px solid #dc3545';
                }
            }
            
            log('‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', 'success');
        }

        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        uploadBtn.addEventListener('click', handleUploadClick);
        uploadZone.addEventListener('click', (e) => {
            if (e.target === uploadZone || e.target === uploadBtn) {
                handleUploadClick(e);
            }
        });

        // Drag and drop
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                log(`–§–∞–π–ª—ã –ø–µ—Ä–µ—Ç–∞—â–µ–Ω—ã: ${e.dataTransfer.files.length}`, 'success');
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã –≤ input
                fileInput.files = e.dataTransfer.files;
                // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ change
                const event = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(event);
            }
        });

        log('–í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã', 'success');
        log('–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é! –ù–∞–∂–º–∏—Ç–µ "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã" –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã', 'success');
    </script>
</body>
</html>

